<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Quản lý Sản phẩm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease-in-out;
        }

        /* Dark Mode Transitions */
        .dark body {
            background-color: #121212;
        }
        .dark .bg-white {
            background-color: #1f1f1f;
        }
        .dark .text-gray-800 {
            color: #e0e0e0;
        }
        .dark .text-gray-700 {
            color: #bdbdbd;
        }
        .dark .text-gray-600 {
            color: #9e9e9e;
        }
        .dark .text-gray-500 {
            color: #757575;
        }
        .dark .border-gray-300 {
            border-color: #424242;
        }
        .dark .border-gray-200 {
            border-color: #333;
        }
        .dark .bg-gray-100 {
            background-color: #1a1a1a;
        }
        .dark .bg-gray-50 {
            background-color: #242424;
        }
        .dark .bg-gray-200 {
            background-color: #424242;
        }
        .dark input, .dark select {
            background-color: #2c2c2c;
            color: #e0e0e0;
        }
        .dark input::placeholder {
            color: #888;
        }

        /* Custom Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }

        @keyframes toast-in-right {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-enter-active {
            animation: toast-in-right 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .pulse-animation {
            animation: pulse 1.5s infinite;
        }

        .toggle-icon {
            transition: transform 0.3s ease;
        }
        .collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }

        /* Thêm hiệu ứng hover cho các nút quản lý phân loại */
        .category-actions button:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 p-8 flex items-center justify-center min-h-screen transition-all duration-300">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-2xl w-full max-w-2xl transform transition-all duration-500">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100"></h1>
            <button id="toggle-dark-mode" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 transition-colors duration-300">
                <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.847 8.621a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.06l1.59-1.591zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.389 18.847a.75.75 0 00-1.06-1.06l-1.59 1.59a.75.75 0 01-1.06 1.06l-1.591-1.59a.75.75 0 00-1.06 1.06l1.59 1.591a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.06 1.06zM6.75 12a.75.75 0 00-.75-.75H3a.75.75 0 000 1.5h2.25a.75.75 0 00.75-.75zM4.621 17.389a.75.75 0 00-1.06-1.06l-1.59 1.59a.75.75 0 101.06 1.06l1.59-1.59zM12 18.75a.75.75 0 00-.75.75v2.25a.75.75 0 001.5 0V19.5a.75.75 0 00-.75-.75zM6.75 12a.75.75 0 00-.75-.75H3a.75.75 0 000 1.5h2.25a.75.75 0 00.75-.75zM17.389 18.847a.75.75 0 00-1.06-1.06l-1.59 1.59a.75.75 0 01-1.06 1.06l-1.591-1.59a.75.75 0 00-1.06 1.06l1.59 1.591a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.06 1.06zM6.75 12a.75.75 0 00-.75-.75H3a.75.75 0 000 1.5h2.25a.75.75 0 00.75-.75zM4.621 17.389a.75.75 0 00-1.06-1.06l-1.59 1.59a.75.75 0 101.06 1.06l1.59-1.59zM12 18.75a.75.75 0 00-.75.75v2.25a.75.75 0 001.5 0V19.5a.75.75 0 00-.75-.75zM6.75 12a.75.75 0 00-.75-.75H3a.75.75 0 000 1.5h2.25a.75.75 0 00.75-.75z" />
                </svg>
                <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" viewBox="0 0 24 24" fill="currentColor">
                    <path fill-rule="evenodd" d="M9.52 2.378a.75.75 0 01.416.828c.17.844.004 1.703-.182 2.536A9.003 9.003 0 0021.75 12c0-.623-.09-1.238-.261-1.838a.75.75 0 111.449-.691A10.501 10.501 0 0124 12c0 5.197-3.94 9.45-9.003 9.959-1.29.13-2.583.199-3.876.199a10.435 10.435 0 01-10.419-10.38l-.001-.021-.002-.026-.002-.036-.002-.047-.002-.058-.002-.069-.001-.082-.001-.091a10.5 10.5 0 0110.5-10.5z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
        <div class="flex items-center space-x-4 mb-6">
            <div class="relative flex-grow">
                <input
                    type="text"
                    id="search-input"
                    placeholder="Tìm kiếm sản phẩm..."
                    class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-lime-500 focus:border-lime-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"
                />
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
            </div>
            <button
                id="toggle-form-btn"
                class="w-12 h-12 flex-shrink-0 flex items-center justify-center bg-lime-500 text-white rounded-full font-semibold text-2xl hover:bg-lime-600 transition transform hover:scale-110 duration-300 shadow-lg"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                </svg>
            </button>
        </div>
        <div id="history-section" class="mb-6">
            <h2 class="text-md font-semibold text-gray-700 dark:text-gray-400 mb-2">Lịch sử tìm kiếm gần đây</h2>
            <div id="history-list" class="flex flex-wrap gap-2">
            </div>
        </div>
        <div id="product-form-section" class="p-4 rounded-2xl bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 animate-fade-in hidden">
            <div class="mb-6">
                <h2 id="form-title" class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-200">Thêm sản phẩm</h2>
                <form id="product-form" class="space-y-3">
                    <div>
                        <label for="product-name" class="block text-sm font-medium text-gray-700 dark:text-gray-400">Tên sản phẩm</label>
                        <div class="relative">
                            <input
                                type="text"
                                id="product-name"
                                placeholder="Nhập tên sản phẩm..."
                                required
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-lime-500 focus:border-lime-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"
                            />
                            <ul id="product-name-suggestions" class="absolute z-10 w-full mt-1 bg-white dark:bg-gray-700 rounded-lg shadow-lg max-h-48 overflow-y-auto border border-gray-200 dark:border-gray-600 hidden">
                            </ul>
                        </div>
                    </div>
                    <div>
                        <label for="product-quantity" class="block text-sm font-medium text-gray-700 dark:text-gray-400">Số lượng (Tùy chọn)</label>
                        <input
                            type="number"
                            id="product-quantity"
                            placeholder="Nhập số lượng..."
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-lime-500 focus:border-lime-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"
                        />
                    </div>
                    <div>
                        <label for="product-unit" class="block text-sm font-medium text-gray-700 dark:text-gray-400">Đơn vị tính (Tùy chọn)</label>
                        <input
                            type="text"
                            id="product-unit"
                            placeholder="Ví dụ: hộp, vỉ, viên..."
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-lime-500 focus:border-lime-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"
                        />
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="new-category-input" class="block text-sm font-medium text-gray-700 dark:text-gray-400">Phân loại mới</label>
                            <input
                                type="text"
                                id="new-category-input"
                                placeholder="Thêm mới..."
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-lime-500 focus:border-lime-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"
                            />
                        </div>
                        <div>
                            <label for="product-category" class="block text-sm font-medium text-gray-700 dark:text-gray-400">Hoặc chọn phân loại</label>
                            <select
                                id="product-category"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-lime-500 focus:border-lime-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"
                            >
                                <option value="">Chọn một loại</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button type="submit" id="submit-btn" class="flex-grow bg-lime-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-lime-700 transition transform hover:scale-105 duration-300 text-sm disabled:bg-gray-400 disabled:cursor-not-allowed">
                            Thêm sản phẩm
                        </button>
                        <button
                            type="button"
                            id="cancel-edit-btn"
                            class="hidden bg-gray-400 text-white py-2 px-4 rounded-lg font-semibold hover:bg-gray-500 transition duration-300 text-sm"
                        >
                            Hủy
                        </button>
                    </div>
                </form>
            </div>
            <div class="p-4 rounded-2xl bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 animate-fade-in mt-4">
                <button id="toggle-category-btn" class="flex items-center justify-between w-full text-xl font-semibold mb-2 text-gray-700 dark:text-gray-200 focus:outline-none">
                    <span>Quản lý Phân loại</span>
                    <svg id="toggle-category-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700 dark:text-gray-200 toggle-icon transform" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
                <div id="category-content" class="hidden">
                    <div class="relative mb-4">
                        <input
                            type="text"
                            id="category-search-input"
                            placeholder="Tìm kiếm phân loại..."
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-lime-500 focus:border-lime-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"
                        />
                    </div>
                    <ul id="category-list" class="space-y-2"></ul>
                </div>
            </div>
            <div id="product-list-section">
                <hr class="my-4 border-gray-200 dark:border-gray-600" />
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-200">Danh sách sản phẩm</h2>
                    <div class="flex items-center space-x-2">
                        <label for="sort-by" class="text-sm text-gray-600 dark:text-gray-400">Sắp xếp:</label>
                        <select id="sort-by" class="px-2 py-1 rounded-lg border border-gray-300 dark:border-gray-600 text-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                            <option value="createdAt-desc">Mới nhất</option>
                            <option value="name-asc">Tên (A-Z)</option>
                            <option value="name-desc">Tên (Z-A)</option>
                            <option value="quantity-asc">Số lượng (tăng dần)</option>
                            <option value="quantity-desc">Số lượng (giảm dần)</option>
                        </select>
                    </div>
                </div>
                <div class="relative mb-4">
                    <input
                        type="text"
                        id="product-list-search-input"
                        placeholder="Tìm kiếm trong danh sách..."
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-lime-500 focus:border-lime-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"
                    />
                </div>
                <ul id="product-list" class="space-y-2"></ul>
                <div id="no-products" class="hidden text-center text-gray-500 dark:text-gray-400 italic mt-4">Không có sản phẩm nào.</div>
                <div id="load-more-container" class="flex justify-center mt-4 hidden">
                    <button
                        id="load-more-btn"
                        class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 py-2 px-6 rounded-full font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition transform hover:scale-105 duration-300"
                    >
                        Tải thêm
                    </button>
                </div>
            </div>
            <hr class="my-4 border-gray-200 dark:border-gray-600" />
            <div class="animate-fade-in">
                <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-200">Sao lưu & Phục hồi</h2>
                <div class="flex flex-col space-y-3">
                    <button
                        id="export-btn"
                        class="w-full bg-lime-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-lime-600 transition duration-300 text-sm disabled:bg-gray-400 disabled:cursor-not-allowed"
                    >
                        Sao lưu dữ liệu
                    </button>
                    <div class="flex items-center space-x-2">
                        <input type="file" id="import-input" accept=".json" class="flex-grow text-sm text-gray-500 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-gray-200 dark:file:bg-gray-700 file:text-gray-700 dark:file:text-gray-200 hover:file:bg-gray-300 dark:hover:file:bg-gray-600"/>
                    </div>
                </div>
            </div>
        </div>
        <div id="search-results-section" class="hidden p-4 rounded-2xl bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 animate-fade-in">
            <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-4">Kết quả tìm kiếm</h2>
            <ul id="search-results-list" class="space-y-2"></ul>
            <div id="no-results" class="hidden text-center text-gray-500 dark:text-gray-400 italic mt-4">Không tìm thấy sản phẩm nào.</div>
        </div>
    </div>
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white dark:bg-gray-800">
            <div class="mt-3 text-center">
                <h3 id="confirmation-title" class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100"></h3>
                <div class="mt-2 px-7 py-3">
                    <p id="confirmation-message" class="text-sm text-gray-500 dark:text-gray-400"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirm-yes" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500">
                        Đồng ý
                    </button>
                    <button id="confirm-no" class="mt-3 px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        Hủy
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="rename-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white dark:bg-gray-800">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">Đổi tên phân loại</h3>
                <div class="mt-2 px-7 py-3">
                    <input type="text" id="rename-category-input" placeholder="Nhập tên mới..." class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-lime-500 focus:border-lime-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" />
                </div>
                <div class="items-center px-4 py-3">
                    <button id="rename-confirm-btn" class="px-4 py-2 bg-lime-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-lime-600 focus:outline-none focus:ring-2 focus:ring-lime-500">
                        Xác nhận
                    </button>
                    <button id="rename-cancel-btn" class="mt-3 px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        Hủy
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="toast-notification" class="fixed bottom-5 right-5 p-4 rounded-lg shadow-lg z-50 hidden">
        <div class="flex items-center space-x-2">
            <svg id="toast-icon-success" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            <svg id="toast-icon-error" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
            <span id="toast-text" class="text-white"></span>
        </div>
    </div>
    <script>
        // --- Cấu hình IndexedDB và các biến toàn cục ---
        const DB_NAME = 'product-db';
        const DB_VERSION = 4;
        const STORE_PRODUCTS = 'products';
        const STORE_CATEGORIES = 'categories';
        const STORE_HISTORY = 'search_history';
        const LAST_BACKUP_TIME_KEY = 'lastBackupTime';
        const PAGE_SIZE = 10;
        const HISTORY_LIMIT = 5;

        let products = [];
        let categories = [];
        let searchHistory = [];
        let currentPage = 1;
        let currentSort = { key: 'createdAt', direction: 'desc' };
        let searchTimeoutId = null;

        // --- Lấy các phần tử DOM ---
        const productFormSection = document.getElementById('product-form-section');
        const searchResultsSection = document.getElementById('search-results-section');
        const toggleFormBtn = document.getElementById('toggle-form-btn');
        const searchInput = document.getElementById('search-input');
        const categorySearchInput = document.getElementById('category-search-input');
        const productListSearchInput = document.getElementById('product-list-search-input');
        const productForm = document.getElementById('product-form');
        const productNameInput = document.getElementById('product-name');
        const productNameSuggestions = document.getElementById('product-name-suggestions');
        const productQuantityInput = document.getElementById('product-quantity');
        const productUnitInput = document.getElementById('product-unit');
        const productCategorySelect = document.getElementById('product-category');
        const newCategoryInput = document.getElementById('new-category-input');
        const submitBtn = document.getElementById('submit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const formTitle = document.getElementById('form-title');
        const productList = document.getElementById('product-list');
        const categoryList = document.getElementById('category-list');
        const searchResultsList = document.getElementById('search-results-list');
        const noProductsMessage = document.getElementById('no-products');
        const noResultsMessage = document.getElementById('no-results');
        const exportBtn = document.getElementById('export-btn');
        const importInput = document.getElementById('import-input');
        const sortBySelect = document.getElementById('sort-by');
        const loadMoreBtn = document.getElementById('load-more-btn');
        const loadMoreContainer = document.getElementById('load-more-container');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationTitle = document.getElementById('confirmation-title');
        const confirmationMessage = document.getElementById('confirmation-message');
        const confirmYesBtn = document.getElementById('confirm-yes');
        const confirmNoBtn = document.getElementById('confirm-no');
        const toastNotification = document.getElementById('toast-notification');
        const toastText = document.getElementById('toast-text');
        const toastIconSuccess = document.getElementById('toast-icon-success');
        const toastIconError = document.getElementById('toast-icon-error');
        const toggleCategoryBtn = document.getElementById('toggle-category-btn');
        const categoryContent = document.getElementById('category-content');
        const historyList = document.getElementById('history-list');
        const toggleDarkModeBtn = document.getElementById('toggle-dark-mode');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        const renameModal = document.getElementById('rename-modal');
        const renameCategoryInput = document.getElementById('rename-category-input');
        const renameConfirmBtn = document.getElementById('rename-confirm-btn');
        const renameCancelBtn = document.getElementById('rename-cancel-btn');

        let isEditing = false;
        let currentProductId = null;
        let currentCategoryToRename = null;

        // --- Helper Functions ---
        const showElement = (element) => element.classList.remove('hidden');
        const hideElement = (element) => element.classList.add('hidden');

        // Hàm VIẾT HOA TOÀN BỘ (Dùng cho Tên sản phẩm)
        const toUpperCase = (str) => {
            if (!str) return '';
            return str.toUpperCase();
        };

        // Hàm Viết hoa chữ cái đầu tiên của mỗi từ (Dùng cho Đơn vị tính, Phân loại)
        const capitalizeFirstLetterOfEachWord = (str) => {
            if (!str) return '';
            const words = str.toLowerCase().split(' ').filter(word => word.length > 0);
            for (let i = 0; i < words.length; i++) {
                words[i] = words[i].charAt(0).toUpperCase() + words[i].slice(1);
            }
            return words.join(' ');
        };

        // Chuẩn hóa chuỗi để tìm kiếm không dấu
        const normalizeString = (str) => {
            if (!str) return '';
            return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        };

        const showLoading = (btn) => {
            btn.innerHTML = `<svg class="spinner h-5 w-5 text-white animate-spin" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
            btn.disabled = true;
        };

        const hideLoading = (btn, text) => {
            btn.innerHTML = text;
            btn.disabled = false;
        };

        const showToast = (message, isError = false) => {
            toastText.textContent = message;
            if (isError) {
                toastNotification.classList.remove('bg-green-500');
                toastNotification.classList.add('bg-red-500');
                showElement(toastIconError);
                hideElement(toastIconSuccess);
            } else {
                toastNotification.classList.remove('bg-red-500');
                toastNotification.classList.add('bg-green-500');
                showElement(toastIconSuccess);
                hideElement(toastIconError);
            }
            showElement(toastNotification);
            toastNotification.classList.add('toast-enter-active');
            setTimeout(() => {
                hideElement(toastNotification);
                toastNotification.classList.remove('toast-enter-active');
            }, 4000);
        };

        const showConfirmationModal = (title, message, onConfirm) => {
            confirmationTitle.textContent = title;
            confirmationMessage.textContent = message;
            showElement(confirmationModal);

            const handleConfirm = () => {
                onConfirm();
                hideElement(confirmationModal);
                confirmYesBtn.removeEventListener('click', handleConfirm);
                confirmNoBtn.removeEventListener('click', handleCancel);
            };

            const handleCancel = () => {
                hideElement(confirmationModal);
                confirmYesBtn.removeEventListener('click', handleConfirm);
                confirmNoBtn.removeEventListener('click', handleCancel);
            };

            confirmYesBtn.addEventListener('click', handleConfirm);
            confirmNoBtn.addEventListener('click', handleCancel);
        };

        const sortAndFilterProducts = () => {
            const productListQuery = normalizeString(productListSearchInput.value.trim());

            const filteredProducts = products.filter(product => {
                const nameMatch = normalizeString(product.name).includes(productListQuery);
                const categoryMatch = normalizeString(product.category).includes(productListQuery);
                return nameMatch || categoryMatch;
            });

            const sortedProducts = [...filteredProducts].sort((a, b) => {
                const aValue = a[currentSort.key];
                const bValue = b[currentSort.key];

                if (typeof aValue === 'string' && typeof bValue === 'string') {
                    return currentSort.direction === 'asc'
                         ? normalizeString(aValue).localeCompare(normalizeString(bValue))
                         : normalizeString(bValue).localeCompare(normalizeString(aValue));
                } else {
                    if (aValue === null) return currentSort.direction === 'asc' ? 1 : -1;
                    if (bValue === null) return currentSort.direction === 'asc' ? -1 : 1;
                    if (currentSort.direction === 'asc') {
                        return aValue - bValue;
                    } else {
                        return bValue - aValue;
                    }
                }
            });

            const visibleProducts = sortedProducts.slice(0, currentPage * PAGE_SIZE);
            return { visibleProducts, totalFiltered: sortedProducts.length };
        };

        const renderProducts = () => {
            const { visibleProducts, totalFiltered } = sortAndFilterProducts();
            productList.innerHTML = '';
            hideElement(noProductsMessage);

            if (visibleProducts.length === 0) {
                showElement(noProductsMessage);
            } else {
                visibleProducts.forEach((product, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center px-4 py-2 bg-white dark:bg-gray-700 rounded-lg shadow-sm border border-gray-200 dark:border-gray-600 transition hover:shadow-md duration-200 animate-fade-in';
                    li.style.animationDelay = `${index * 0.05}s`;
                    li.innerHTML = `
                        <div class="flex-grow flex items-center">
                            <span class="mr-2 text-sm font-semibold text-gray-500 dark:text-gray-400">${index + 1}.</span>
                            <div>
                                <p class="font-semibold text-gray-800 dark:text-gray-100 text-sm">
                                    ${product.name}
                                    <span class="text-xs text-gray-400 dark:text-gray-500 italic">
                                        ${(product.quantity || product.unit) ? `(${product.quantity || ''} ${product.unit || ''})` : ''}
                                    </span>
                                </p>
                                <span class="text-xs text-gray-500 dark:text-gray-400 italic">${product.category}</span>
                            </div>
                        </div>
                        <div class="flex space-x-2 ml-4">
                            <button class="edit-btn" data-id="${product.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-lime-500 hover:text-lime-600 transition duration-300" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                    <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 000 2H4v10h10v-4a1 1 0 102 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <button class="delete-btn" data-id="${product.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 hover:text-red-600 transition duration-300" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 00-.894.553L7.382 4H4a1 1 000 2v10a2 2 002 2h8a2 2 002-2V6a1 1 0100-2h-3.382l-.724-1.447A1 1 0011 2H9zM7 8a1 1 012 0v6a1 1 011-2 0V8zm6 0a1 1 011-2 0v6a1 1 0112 0V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    `;
                    productList.appendChild(li);
                });
            }

            document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => handleEditClick(parseInt(e.currentTarget.dataset.id))));
            document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteClick(parseInt(e.currentTarget.dataset.id))));

            if (totalFiltered > currentPage * PAGE_SIZE) {
                showElement(loadMoreContainer);
            } else {
                hideElement(loadMoreContainer);
            }
        };

        const renderCategories = () => {
            productCategorySelect.innerHTML = '<option value="">Chọn một loại</option>';
            categoryList.innerHTML = '';

            const categoryQuery = normalizeString(categorySearchInput.value.trim());
            const filteredCategories = categories.filter(cat => normalizeString(cat).includes(categoryQuery));

            filteredCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                productCategorySelect.appendChild(option);

                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-2 bg-white dark:bg-gray-700 rounded-lg shadow-sm border border-gray-200 dark:border-gray-600';
                li.innerHTML = `
                    <span class="text-sm text-gray-800 dark:text-gray-100 flex-grow">${cat}</span>
                    <div class="category-actions flex space-x-2 ml-2">
                        <button class="rename-category-btn" data-name="${cat}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-lime-500 hover:text-lime-600 transition duration-300" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 000 2H4v10h10v-4a1 1 0 102 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button class="delete-category-btn" data-name="${cat}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500 hover:text-red-600 transition duration-300" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 00-.894.553L7.382 4H4a1 1 000 2v10a2 2 002 2h8a2 2 002-2V6a1 1 0100-2h-3.382l-.724-1.447A1 1 0011 2H9zM7 8a1 1 012 0v6a1 1 011-2 0V8zm6 0a1 1 011-2 0v6a1 1 0112 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
                categoryList.appendChild(li);
            });
            document.querySelectorAll('.rename-category-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const oldName = e.currentTarget.dataset.name;
                    showRenameModal(oldName);
                });
            });
            document.querySelectorAll('.delete-category-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const categoryName = e.currentTarget.dataset.name;
                    handleDeleteCategory(categoryName);
                });
            });
        };

        const renderSearchResults = (results) => {
            searchResultsList.innerHTML = '';
            if (results.length === 0) {
                showElement(noResultsMessage);
            } else {
                hideElement(noResultsMessage);
                results.forEach(product => {
                    const li = document.createElement('li');
                    li.className = 'p-3 bg-white dark:bg-gray-700 rounded-lg shadow-sm border border-gray-200 dark:border-gray-600 flex justify-between items-center';
                    li.innerHTML = `
                        <div class="flex-grow">
                            <p class="font-semibold text-gray-800 dark:text-gray-100 text-sm">
                                ${product.name}
                                <span class="text-xs text-gray-400 dark:text-gray-500 italic">
                                    ${(product.quantity || product.unit) ? `(${product.quantity || ''} ${product.unit || ''})` : ''}
                                </span>
                            </p>
                        </div>
                        <div class="flex-shrink-0">
                            <span class="text-xs text-gray-500 dark:text-gray-400 italic">${product.category}</span>
                        </div>
                    `;
                    searchResultsList.appendChild(li);
                });
            }
        };

        const renderSearchHistory = () => {
            historyList.innerHTML = '';
            if (searchHistory.length > 0) {
                searchHistory.forEach(query => {
                    const button = document.createElement('button');
                    button.textContent = query;
                    button.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-200', 'px-3', 'py-1', 'rounded-full', 'hover:bg-gray-300', 'dark:hover:bg-gray-600', 'transition', 'duration-200', 'text-sm');
                    button.onclick = () => {
                        searchInput.value = query;
                        handleMainSearch();
                    };
                    historyList.appendChild(button);
                });
            }
        };

        // --- Dark Mode Logic ---
        const setupDarkMode = () => {
            const isDarkMode = localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }

            toggleDarkModeBtn.addEventListener('click', () => {
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                    hideElement(moonIcon);
                    showElement(sunIcon);
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                    hideElement(sunIcon);
                    showElement(moonIcon);
                }
            });
        };

        // --- IndexedDB Operations ---
        const db = {
            conn: null,
            async connect() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);

                    request.onerror = (event) => {
                        console.error('IndexedDB error:', event.target.error);
                        showToast('Lỗi IndexedDB. Vui lòng kiểm tra console.', true);
                        reject(event.target.error);
                    };

                    request.onupgradeneeded = (event) => {
                        this.conn = event.target.result;
                        const oldVersion = event.oldVersion;

                        if (oldVersion < 1) {
                            if (!this.conn.objectStoreNames.contains(STORE_PRODUCTS)) {
                                const productStore = this.conn.createObjectStore(STORE_PRODUCTS, { keyPath: 'id', autoIncrement: true });
                                productStore.createIndex('name', 'name', { unique: false });
                                productStore.createIndex('category', 'category', { unique: false });
                                productStore.createIndex('quantity', 'quantity', { unique: false });
                                productStore.createIndex('createdAt', 'createdAt', { unique: false });
                            }
                            if (!this.conn.objectStoreNames.contains(STORE_CATEGORIES)) {
                                this.conn.createObjectStore(STORE_CATEGORIES, { keyPath: 'name' });
                            }
                            if (!this.conn.objectStoreNames.contains(STORE_HISTORY)) {
                                this.conn.createObjectStore(STORE_HISTORY, { keyPath: 'id' });
                            }
                        }
                    };

                    request.onsuccess = (event) => {
                        this.conn = event.target.result;
                        console.log("IndexedDB connected.");
                        resolve(this.conn);
                    };
                });
            },

            async getAll(storeName) {
                return new Promise(async (resolve, reject) => {
                    const transaction = this.conn.transaction(storeName, 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },

            async add(storeName, item) {
                return new Promise(async (resolve, reject) => {
                    const transaction = this.conn.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.add(item);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },

            async put(storeName, item) {
                return new Promise(async (resolve, reject) => {
                    const transaction = this.conn.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put(item);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },

            async delete(storeName, key) {
                return new Promise(async (resolve, reject) => {
                    const transaction = this.conn.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(key);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            },
            async deleteAll(storeName) {
                return new Promise((resolve, reject) => {
                    const transaction = this.conn.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            },
        };

        // --- Data Loading and Syncing ---
        const loadAllData = async () => {
            try {
                products = await db.getAll(STORE_PRODUCTS);
                const categoriesData = await db.getAll(STORE_CATEGORIES);
                categories = categoriesData.map(c => c.name);
                const historyData = await db.getAll(STORE_HISTORY);
                searchHistory = (historyData.length > 0) ? historyData[0].queries : [];

                renderProducts();
                renderCategories();
                renderSearchHistory();
            } catch (error) {
                console.error("Failed to load data:", error);
                showToast("Không thể tải dữ liệu.", true);
            }
        };

        const saveSearchHistory = async (query) => {
            if (!query) return;
            const newHistory = [query, ...searchHistory.filter(h => h !== query)].slice(0, HISTORY_LIMIT);
            try {
                await db.put(STORE_HISTORY, { id: 1, queries: newHistory });
                searchHistory = newHistory;
                renderSearchHistory();
            } catch (error) {
                console.error('Failed to save search history:', error);
            }
        };

        // --- Data Handling ---
        const handleFormSubmit = async (event) => {
            event.preventDefault();
            // CHỈNH SỬA: Tên sản phẩm dùng toUpperCase()
            const name = toUpperCase(productNameInput.value.trim()); 
            const quantity = productQuantityInput.value ? parseInt(productQuantityInput.value) : null;
            // CHỈNH SỬA: Đơn vị tính dùng capitalizeFirstLetterOfEachWord()
            const unit = capitalizeFirstLetterOfEachWord(productUnitInput.value.trim()); 
            // CHỈNH SỬA: Phân loại mới dùng capitalizeFirstLetterOfEachWord()
            const newCategory = capitalizeFirstLetterOfEachWord(newCategoryInput.value.trim()); 
            const category = newCategory || productCategorySelect.value;

            if (!name) {
                showToast('Tên sản phẩm không được để trống.', true);
                return;
            }
            if (!category) {
                showToast('Phân loại không được để trống.', true);
                return;
            }

            try {
                if (isEditing) {
                    const product = products.find(p => p.id === currentProductId);
                    if (!product) {
                        showToast('Không tìm thấy sản phẩm để cập nhật.', true);
                        return;
                    }
                    product.name = name;
                    product.quantity = quantity;
                    product.unit = unit;
                    product.category = category;

                    showLoading(submitBtn);
                    await db.put(STORE_PRODUCTS, product);
                    showToast('Sản phẩm đã được cập nhật thành công!');

                } else {
                    const newProduct = {
                        name,
                        quantity,
                        unit,
                        category,
                        createdAt: Date.now()
                    };

                    showLoading(submitBtn);
                    const id = await db.add(STORE_PRODUCTS, newProduct);
                    newProduct.id = id;
                    products.push(newProduct);
                    showToast('Sản phẩm đã được thêm thành công!');
                }

                if (newCategory && !categories.includes(newCategory)) {
                    await db.put(STORE_CATEGORIES, { name: newCategory });
                    categories.push(newCategory);
                }

                resetForm();
                renderProducts();
                renderCategories();
                // Bỏ dòng chuyển hướng ra trang tìm kiếm
            } catch (error) {
                showToast('Lỗi khi lưu dữ liệu.', true);
                console.error(error);
            } finally {
                hideLoading(submitBtn, isEditing ? 'Cập nhật sản phẩm' : 'Thêm sản phẩm');
            }
        };

        const handleEditClick = (productId) => {
            const productToEdit = products.find(p => p.id === productId);
            if (!productToEdit) {
                showToast('Không tìm thấy sản phẩm.', true);
                return;
            }

            showElement(productFormSection);
            hideElement(searchResultsSection);

            isEditing = true;
            currentProductId = productId;
            formTitle.textContent = 'Chỉnh sửa sản phẩm';
            submitBtn.textContent = 'Cập nhật sản phẩm';
            showElement(cancelEditBtn);

            productNameInput.value = productToEdit.name;
            productQuantityInput.value = productToEdit.quantity || '';
            productUnitInput.value = productToEdit.unit || '';
            productCategorySelect.value = productToEdit.category;
            newCategoryInput.value = '';
        };

        const handleDeleteClick = (productId) => {
            const productToDelete = products.find(p => p.id === productId);
            showConfirmationModal(
                'Xác nhận xóa',
                `Bạn có chắc chắn muốn xóa sản phẩm "${productToDelete.name}"?`,
                async () => {
                    try {
                        showLoading(confirmYesBtn);
                        await db.delete(STORE_PRODUCTS, productId);
                        products = products.filter(p => p.id !== productId);
                        renderProducts();
                        showToast('Sản phẩm đã được xóa!');
                    } catch (error) {
                        showToast('Lỗi: Không thể xóa sản phẩm.', true);
                        console.error(error);
                    } finally {
                        hideLoading(confirmYesBtn, 'Đồng ý');
                    }
                }
            );
        };

        const showRenameModal = (oldName) => {
            currentCategoryToRename = oldName;
            renameCategoryInput.value = oldName;
            showElement(renameModal);
        };

        const handleRenameCategory = async () => {
            const oldName = currentCategoryToRename;
            // CHỈNH SỬA: Đổi tên phân loại dùng capitalizeFirstLetterOfEachWord()
            const newName = capitalizeFirstLetterOfEachWord(renameCategoryInput.value.trim());
            hideElement(renameModal);

            if (!newName || newName === oldName) {
                return;
            }
            if (categories.includes(newName)) {
                showToast('Tên phân loại đã tồn tại. Vui lòng chọn tên khác.', true);
                return;
            }

            showConfirmationModal(
                'Xác nhận đổi tên phân loại',
                `Bạn có chắc chắn muốn đổi tên phân loại "${oldName}" thành "${newName}"? Thao tác này sẽ cập nhật tất cả sản phẩm liên quan.`,
                async () => {
                    try {
                        const productsToUpdate = products.filter(p => p.category === oldName);
                        await db.delete(STORE_CATEGORIES, oldName);
                        await db.add(STORE_CATEGORIES, { name: newName });

                        for (const product of productsToUpdate) {
                            product.category = newName;
                            await db.put(STORE_PRODUCTS, product);
                        }

                        // Sync in-memory data
                        categories = categories.map(cat => (cat === oldName ? newName : cat));
                        products = products.map(p => (p.category === oldName ? { ...p, category: newName } : p));

                        renderProducts();
                        renderCategories();
                        showToast('Đã đổi tên phân loại và cập nhật sản phẩm thành công!');
                    } catch (error) {
                        console.error('Lỗi khi đổi tên phân loại:', error);
                        showToast('Lỗi khi đổi tên phân loại.', true);
                    }
                }
            );
        };

        const handleDeleteCategory = (categoryName) => {
            showConfirmationModal(
                'Xác nhận xóa phân loại',
                `Bạn có chắc chắn muốn xóa phân loại "${categoryName}"? Tất cả sản phẩm thuộc loại này sẽ bị xóa.`,
                async () => {
                    try {
                        const productsToDelete = products.filter(p => p.category === categoryName);
                        for (const product of productsToDelete) {
                            await db.delete(STORE_PRODUCTS, product.id);
                        }
                        await db.delete(STORE_CATEGORIES, categoryName);

                        // Sync in-memory data
                        products = products.filter(p => p.category !== categoryName);
                        categories = categories.filter(cat => cat !== categoryName);

                        renderProducts();
                        renderCategories();
                        showToast('Đã xóa phân loại và các sản phẩm liên quan!');
                    } catch (error) {
                        console.error('Lỗi khi xóa phân loại:', error);
                        showToast('Lỗi khi xóa phân loại.', true);
                    }
                }
            );
        };

        const resetForm = () => {
            isEditing = false;
            currentProductId = null;
            productForm.reset();
            formTitle.textContent = 'Thêm sản phẩm';
            submitBtn.textContent = 'Thêm sản phẩm';
            hideElement(cancelEditBtn);
        };

        const handleMainSearch = () => {
            const query = normalizeString(searchInput.value.trim());

            if (searchTimeoutId) {
                clearTimeout(searchTimeoutId);
            }

            if (query === '') {
                hideElement(searchResultsSection);
                if (productFormSection.classList.contains('hidden')) {
                    toggleFormBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                        </svg>
                    `;
                }
            } else {
                showElement(searchResultsSection);
                hideElement(productFormSection);
                toggleFormBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" />
                    </svg>
                `;
                const results = products.filter(product => {
                    const nameMatch = normalizeString(product.name).includes(query);
                    const categoryMatch = normalizeString(product.category).includes(query);
                    return nameMatch || categoryMatch;
                });
                renderSearchResults(results);
                searchTimeoutId = setTimeout(() => {
                    saveSearchHistory(searchInput.value.trim());
                }, 1000);
            }
        };

        const exportDataAsJson = async () => {
            try {
                const data = {
                    products: await db.getAll(STORE_PRODUCTS),
                    categories: await db.getAll(STORE_CATEGORIES)
                };
                const jsonData = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `inventory_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // Cập nhật localStorage sau khi sao lưu thành công
                localStorage.setItem(LAST_BACKUP_TIME_KEY, new Date().toISOString().split('T')[0]);
                showToast('Đã sao lưu dữ liệu thành công.');
            } catch (error) {
                console.error('Lỗi khi sao lưu dữ liệu:', error);
                showToast('Không thể sao lưu dữ liệu.', true);
            }
        };

        const checkDailyBackup = () => {
            const today = new Date().toISOString().split('T')[0];
            const lastBackupDate = localStorage.getItem(LAST_BACKUP_TIME_KEY);

            if (lastBackupDate !== today) {
                showToast('Đã đến giờ sao lưu hàng ngày. Vui lòng nhấn nút "Sao lưu dữ liệu" để đảm bảo an toàn!');
            }
        };

        const handleImportData = (file) => {
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    if (!importedData || !importedData.products || !importedData.categories) {
                        throw new Error('Cấu trúc dữ liệu không hợp lệ.');
                    }

                    showConfirmationModal(
                        'Xác nhận khôi phục',
                        'Thao tác này sẽ XÓA tất cả dữ liệu hiện tại và thay thế bằng dữ liệu từ tệp. Bạn có chắc chắn muốn tiếp tục?',
                        async () => {
                            try {
                                await db.deleteAll(STORE_PRODUCTS);
                                await db.deleteAll(STORE_CATEGORIES);
                                await db.deleteAll(STORE_HISTORY);

                                const transaction = db.conn.transaction([STORE_PRODUCTS, STORE_CATEGORIES], 'readwrite');
                                const productStore = transaction.objectStore(STORE_PRODUCTS);
                                const categoryStore = transaction.objectStore(STORE_CATEGORIES);

                                importedData.products.forEach(product => productStore.add(product));
                                importedData.categories.forEach(category => categoryStore.add(category));

                                transaction.oncomplete = () => {
                                    showToast('Dữ liệu đã được khôi phục thành công!');
                                    loadAllData();
                                };
                                transaction.onerror = (e) => {
                                    console.error(e);
                                    showToast('Lỗi khi khôi phục dữ liệu.', true);
                                };
                            } catch (error) {
                                console.error('Lỗi khi khôi phục dữ liệu:', error);
                                showToast('Không thể khôi phục dữ liệu.', true);
                            }
                        }
                    );
                } catch (error) {
                    console.error('Lỗi khi đọc hoặc xử lý tệp JSON:', error);
                    showToast('Tệp không hợp lệ. Vui lòng chọn tệp JSON hợp lệ.', true);
                }
            };
            reader.readAsText(file);
        };

        // --- Event Listeners ---
        window.addEventListener('load', async () => {
            await db.connect();
            loadAllData();
            setupDarkMode();
            checkDailyBackup(); // Thêm hàm kiểm tra sao lưu khi tải trang
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'F3') {
                e.preventDefault();
                searchInput.focus();
                searchInput.select();
            }
        });

        // CHỈNH SỬA: Tên sản phẩm dùng toUpperCase()
        productNameInput.addEventListener('input', (event) => {
            event.target.value = toUpperCase(event.target.value);
            const query = productNameInput.value.trim();
            if (query.length > 0) {
                const suggestions = products.filter(p =>
                    normalizeString(p.name).includes(normalizeString(query)) && p.id !== currentProductId
                );

                productNameSuggestions.innerHTML = '';
                if (suggestions.length > 0) {
                    suggestions.forEach(sug => {
                        const li = document.createElement('li');
                        li.textContent = sug.name;
                        li.className = 'px-4 py-2 hover:bg-gray-200 dark:hover:bg-gray-600 cursor-pointer text-gray-700 dark:text-gray-200';
                        li.addEventListener('click', () => {
                            handleEditClick(sug.id);
                            hideElement(productNameSuggestions);
                        });
                        productNameSuggestions.appendChild(li);
                    });
                    showElement(productNameSuggestions);
                } else {
                    hideElement(productNameSuggestions);
                }
            } else {
                hideElement(productNameSuggestions);
            }
        });

        productNameInput.addEventListener('blur', () => {
            setTimeout(() => {
                hideElement(productNameSuggestions);
            }, 200);
        });

        // Tìm kiếm chính (giữ nguyên không đổi chữ)
        searchInput.addEventListener('input', (event) => {
            handleMainSearch();
        });

        // CHỈNH SỬA: Đơn vị tính dùng capitalizeFirstLetterOfEachWord()
        productUnitInput.addEventListener('input', (event) => {
            event.target.value = capitalizeFirstLetterOfEachWord(event.target.value);
        });

        // CHỈNH SỬA: Phân loại mới dùng capitalizeFirstLetterOfEachWord()
        newCategoryInput.addEventListener('input', (event) => {
            event.target.value = capitalizeFirstLetterOfEachWord(event.target.value);
        });

        toggleFormBtn.addEventListener('click', () => {
            const isFormVisible = !productFormSection.classList.contains('hidden');
            if (isFormVisible) {
                hideElement(productFormSection);
                toggleFormBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                    </svg>
                `;
                resetForm();
            } else {
                showElement(productFormSection);
                hideElement(searchResultsSection);
                toggleFormBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" />
                    </svg>
                `;
            }
        });

        toggleCategoryBtn.addEventListener('click', () => {
            categoryContent.classList.toggle('hidden');
            toggleCategoryBtn.classList.toggle('collapsed');
        });

        productForm.addEventListener('submit', handleFormSubmit);
        cancelEditBtn.addEventListener('click', () => {
            resetForm();
        });

        categorySearchInput.addEventListener('input', renderCategories);
        productListSearchInput.addEventListener('input', () => {
            currentPage = 1;
            renderProducts();
        });

        sortBySelect.addEventListener('change', (event) => {
            const [key, direction] = event.target.value.split('-');
            currentSort = { key, direction };
            currentPage = 1;
            renderProducts();
        });

        loadMoreBtn.addEventListener('click', () => {
            currentPage++;
            renderProducts();
        });

        exportBtn.addEventListener('click', exportDataAsJson);
        importInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                handleImportData(file);
            }
        });

        renameConfirmBtn.addEventListener('click', handleRenameCategory);
        renameCancelBtn.addEventListener('click', () => {
            hideElement(renameModal);
        });
    </script>
</body>
</html>

